<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†å¾Œå°ï½œAI çŸ¥è­˜åº«å¯©æ ¸</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { display: flex; align-items: center; justify-content: space-between; }
        
        /* ç”³è«‹æ¸…å–®è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #666; font-size: 13px; }
        
        .req-item { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; padding: 8px 12px; border-radius: 8px; margin-bottom: 6px; border: 1px solid #eee; }
        .req-name { font-weight: bold; font-size: 14px; color: #555; }
        
        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; gap: 5px; }
        button { border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .btn-ok { background: #28a745; color: white; }
        .btn-no { background: #6c757d; color: white; }
        .btn-refresh { background: #007bff; color: white; padding: 10px 20px; font-size: 14px; border-radius: 8px; }
        
        /* ç•¶æ¬¡æ ¸å‡†æš«å­˜å€ï¼šç¶ è‰²å¼·èª¿ */
        .session-box { background: #fff; padding: 25px; border-radius: 12px; border: 2px solid #28a745; box-shadow: 0 4px 12px rgba(40,167,69,0.1); }
        .session-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        select { padding: 10px; border-radius: 6px; border: 1px solid #ddd; flex-grow: 1; outline: none; }
        textarea { width: 100%; height: 130px; padding: 12px; box-sizing: border-box; border-radius: 8px; border: 1px solid #28a745; font-family: monospace; background: #f4fff4; line-height: 1.6; }
        .btn-copy-now { background: #28a745; color: white; padding: 10px 25px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="container">
    <h1>
        AI çŸ¥è­˜åº«ç®¡ç†å¾Œå° 
        <button class="btn-refresh" onclick="fetchData()">ğŸ”„ é‡æ–°æ•´ç†å¾…è™•ç†ç”³è«‹</button>
    </h1>
    
    <table>
        <thead>
            <tr>
                <th width="80">å“¡ç·¨</th>
                <th width="230">ç”³è«‹äºº Email (Gmail)</th>
                <th>å¾…è™•ç†é …ç›® (ç¨ç«‹æ ¸å‡†/æ‹’çµ•)</th>
            </tr>
        </thead>
        <tbody id="mainTable">
            <tr><td colspan="3" style="text-align:center; padding:40px;">æ­£åœ¨è®€å– Pending ç”³è«‹ä¸­...</td></tr>
        </tbody>
    </table>

    <div class="session-box">
        <div class="session-header">
            <h3 style="color:#28a745; margin:0;">âœ… ç•¶æ¬¡æ‰‹å‹•æ ¸å‡†åå–® (æš«å­˜å€)</h3>
            <select id="themeSelector" onchange="updateBufferView()">
                <option value="">-- è«‹é¸æ“‡ä¸»é¡Œä»¥è¤‡è£½ Email --</option>
            </select>
            <button class="btn-copy-now" onclick="copyBuffer()">ä¸€éµè¤‡è£½ç•¶æ¬¡æ¸…å–®</button>
            <button style="background:#ddd; color:#333; padding:10px; border-radius:6px;" onclick="resetBuffer()">æ¸…ç©ºæš«å­˜</button>
        </div>
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">æ­¤è™•åƒ…é¡¯ç¤ºæ‚¨ã€Œæœ¬æ¬¡é–‹å•Ÿç¶²é å¾Œã€é»æ“Šæ ¸å‡†çš„äººå“¡ï¼Œæ–¹ä¾¿æ‚¨æ‰¹æ¬¡è²¼å…¥ NotebookLMã€‚</p>
        <textarea id="bufferPool" readonly placeholder="è«‹å…ˆåœ¨ä¸Šæ–¹åŸ·è¡Œæ ¸å‡†å‹•ä½œ..."></textarea>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbypQPLRhhOSN8hmkuemznLeqT6Kvnr5mVT492wZBf_omo064fFU0DWhbO54CPDX3w7B/exec"; 

    // ç”¨æ–¼ç´€éŒ„ç•¶æ¬¡æ“ä½œæ ¸å‡†çš„åå–®
    let currentSessionBuffer = {}; 
    let allThemes = [];

    async function fetchData() {
        const table = document.getElementById('mainTable');
        const selector = document.getElementById('themeSelector');
        table.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:40px;">åŒæ­¥ä¸­...</td></tr>';
        
        try {
            const res = await fetch(GAS_URL + "?t=" + new Date().getTime());
            const data = await res.json();
            
            // è‡ªå‹•åµæ¸¬ä¸»é¡Œæ¬„ä½
            const systemFields = ['employee_id', 'timestamp', 'email', 'row_index'];
            allThemes = Object.keys(data[0] || {}).filter(k => !systemFields.includes(k));

            // åˆå§‹åŒ–æš«å­˜å™¨
            allThemes.forEach(t => { if(!currentSessionBuffer[t]) currentSessionBuffer[t] = []; });

            // æ›´æ–°ä¸‹æ‹‰é¸å–®
            const selected = selector.value;
            selector.innerHTML = '<option value="">-- è«‹é¸æ“‡ä¸»é¡Œä»¥è¤‡è£½ Email --</option>';
            allThemes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = t;
                selector.appendChild(opt);
            });
            selector.value = selected;

            renderTable(data, allThemes);
        } catch (e) {
            table.innerHTML = '<tr><td colspan="3" style="color:red; text-align:center;">è®€å–å¤±æ•—ã€‚</td></tr>';
        }
    }

    function renderTable(data, themes) {
        const tbody = document.getElementById('mainTable');
        tbody.innerHTML = '';

        data.forEach(row => {
            // åªæŠ“å–ç‹€æ…‹ç‚º pending çš„é …ç›®
            const pendingItems = themes.filter(t => String(row[t] || "").trim().toLowerCase() === 'pending');
            if (pendingItems.length === 0) return;

            const tr = document.createElement('tr');
            let actions = '';
            pendingItems.forEach(theme => {
                actions += `
                <div class="req-item">
                    <span class="req-name">${theme}</span>
                    <div class="btn-group">
                        <button class="btn-ok" onclick="handle(this, ${row.row_index}, '${row.email}', '${theme}', 'approved')">æ ¸å‡†</button>
                        <button class="btn-no" onclick="handle(this, ${row.row_index}, '${row.email}', '${theme}', '')">æ‹’çµ•</button>
                    </div>
                </div>`;
            });
            tr.innerHTML = `<td><b>${row.employee_id}</b></td><td>${row.email}</td><td>${actions}</td>`;
            tbody.appendChild(tr);
        });

        if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:40px; color:#999;">ç›®å‰ç„¡å¾…è™•ç†é …ç›®ã€‚</td></tr>';
    }

    // åŸ·è¡Œæ ¸å‡†æˆ–æ‹’çµ•
    async function handle(btn, rowIndex, email, theme, status) {
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = "...";

        try {
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'approveSpecific', row_index: rowIndex, category: theme, status: status })
            });

            if (status === 'approved') {
                // åƒ…å°‡ã€Œæœ¬æ¬¡æ ¸å‡†ã€çš„ Email å­˜å…¥æš«å­˜å€
                if (!currentSessionBuffer[theme].includes(email)) {
                    currentSessionBuffer[theme].push(email);
                }
                btn.closest('.req-item').style.background = "#e6ffed";
                btn.textContent = "å·²æ ¸å‡†";
            } else {
                // æ‹’çµ•å¾Œå°‡æ¬„ä½è¨­ç‚ºç©ºï¼Œé …ç›®å¾åˆ—è¡¨æ¶ˆå¤±
                btn.closest('.req-item').style.background = "#f1f3f5";
                btn.textContent = "å·²æ‹’çµ•";
                setTimeout(() => btn.closest('.req-item').remove(), 1000);
            }
            updateBufferView();
        } catch (e) {
            alert('æ“ä½œå¤±æ•—');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    // æ›´æ–°æš«å­˜å€æ–‡å­—æ¡† (æ›è¡Œå€åˆ†)
    function updateBufferView() {
        const theme = document.getElementById('themeSelector').value;
        const pool = document.getElementById('bufferPool');
        if (!theme) { pool.value = ""; return; }
        pool.value = currentSessionBuffer[theme].join('\n');
    }

    function copyBuffer() {
        const el = document.getElementById('bufferPool');
        if (!el.value) return alert("æ¸…å–®ç‚ºç©ºã€‚");
        el.select();
        document.execCommand('copy');
        alert('å·²è¤‡è£½ç•¶æ¬¡æ ¸å‡†æ¸…å–®ï¼');
    }

    function resetBuffer() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºæœ¬æ¬¡æ“ä½œçš„æ ¸å‡†æš«å­˜å—ï¼Ÿ")) {
            currentSessionBuffer = {};
            allThemes.forEach(t => currentSessionBuffer[t] = []);
            updateBufferView();
        }
    }

    window.onload = fetchData;
</script>

</body>
</html>