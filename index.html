<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å‰µèš AI çŸ¥è­˜åº«</title>
  <style>
    :root{ --primary:#007bff; --bg:#f4f7f6; --card:#fff; --success:#28a745; --warning:#ffc107; }
    body{font-family:"Microsoft JhengHei",sans-serif;background:var(--bg);margin:0;padding:20px;color:#333;line-height:1.6;}
    .container{max-width:1500px;margin:0 auto;}
    
    /* æ¨™é ­æ¨£å¼ */
    .header{text-align:center;margin-bottom:25px;}
    .header h1 { margin:0 0 10px; font-size: 28px; }
    #meBar{margin-top:10px;color:#666;font-size:14px;background:#fff;padding:10px;border-radius:30px;display:inline-block;box-shadow:0 2px 5px rgba(0,0,0,0.05);}
    
    /* æ‰¹æ¬¡ç”³è«‹é¢æ¿æ¨£å¼ */
    .batch-apply-panel {
      background: #fff;
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 4px 18px rgba(0,0,0,0.05);
      display: none; /* åˆå§‹éš±è—ï¼Œæœ‰å¯ç”³è«‹é …ç›®æ‰é¡¯ç¤º */
    }
    .batch-apply-panel h3 { margin-top: 0; color: #444; font-size: 18px; border-left: 4px solid var(--primary); padding-left: 12px; }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; margin: 20px 0; }
    .check-item {
      display: flex;
      align-items: center;
      background: #f8f9fa;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
      border: 1px solid #eee;
    }
    .check-item:hover { background: #e9ecef; border-color: var(--primary); }
    .check-item input { margin-right: 10px; width: 18px; height: 18px; cursor: pointer; }
    
    .btn-submit-batch {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 15px;
      transition: 0.3s;
    }
    .btn-submit-batch:hover { background: #0056b3; transform: translateY(-1px); }
    .btn-submit-batch:disabled { background: #ccc; cursor: not-allowed; }

    /* ç£è²¼ç¶²æ ¼æ¨£å¼ */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px;}
    .tile{
      background:var(--card); border-radius:15px; padding:25px;
      text-decoration:none; color:#333; border:1px solid #eee;
      box-shadow:0 4px 10px rgba(0,0,0,0.03);
      transition:0.3s ease;
      display:block;
      text-align: center;
    }
    .tile.active:hover{transform:translateY(-5px); box-shadow:0 12px 25px rgba(0,0,0,.1); border-color:var(--primary);}
    
    .icon{font-size:42px;margin-bottom:15px; display: block;}
    .title{font-weight:700;font-size:18px;margin-bottom:12px; color: #222;}
    .badge{display:inline-block;font-size:12px;padding:4px 12px;border-radius:20px;background:#f1f3f5;color:#666;font-weight:bold;}
    .badge.open{background:#e6ffed;color:#1e7e34;}
    .badge.pending{background:#fff3cd;color:#856404;}
    .badge.locked{background:#f1f3f5;color:#999;}

    .topnote{color: #888; text-align: center; font-size: 13px; margin-bottom: 20px;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>å‰µèš AI çŸ¥è­˜åº«</h1>
      <div id="meBar">é©—è­‰èº«åˆ†ä¸­...</div>
    </div>

    <div class="batch-apply-panel" id="batchPanel">
      <h3>å¿«é€Ÿç”³è«‹æ¬Šé™</h3>
      <p style="color:#666; font-size:14px;">è«‹å‹¾é¸æ‚¨æ¬²ç”³è«‹çš„çŸ¥è­˜åº«å°ˆæ¡ˆï¼š</p>
      <div class="checkbox-group" id="checkGroup"></div>
      <button class="btn-submit-batch" id="btnBatchApply" onclick="submitBatchRequest()">æäº¤æ‰¹æ¬¡ç”³è«‹</button>
    </div>

    <div class="topnote"> æç¤ºï¼šç£è²¼è®Šç‚ºå½©è‰²å¾Œå³å¯é»æ“Šé€²å…¥å°æ‡‰çš„ NotebookLM ç­†è¨˜æœ¬ã€‚</div>

    <div class="grid" id="tileGrid"></div>
  </div>

<script>
(function(){
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwUHdJ8PkH5zdaNcSfFkzkZvcd2fTWQdQX9aUh40aPh5M0wqb_iFuOIPp03MEsaziOL/exec";

  const DEFAULT_TILES = [
      { name: "Project0", icon: "âš–ï¸", url: "https://notebooklm.google.com/notebook/a991ade1-52f1-4834-b4c4-36cebe9d4b60" }, //notebooklm share
      { name: "Project1", icon: "ğŸ‘¥", url: "https://notebooklm.google.com/notebook/d2e70371-a1bf-4a20-8196-bee44f5d2afa" }, //notebooklm share
      { name: "Project2", icon: "ğŸ’°", url: "https://notebooklm.google.com/notebook/a9951a16-f4a1-480e-92cf-496838e5f3c9" }, //animal detection
      { name: "Project3", icon: "ğŸ“ˆ", url: "https://notebooklm.google.com/notebook/71e0f5b8-7b1e-462a-9ec2-739b9b9095d1" }, //yolo paper
      { name: "Project4", icon: "ğŸ”¬", url: "https://notebooklm.google.com/notebook/778f5dcb-0f7c-49d7-8ef5-d77a3b6d64ec" }, //æ°´ä½ç›£æ¸¬
  ];

  async function checkAuthAndGetStatus() {
    const email = localStorage.getItem('user_email');
    if (!email) { location.href = 'login.html'; return null; }

    try {
        const res = await fetch(GAS_URL + "?t=" + new Date().getTime());
        const allRequests = await res.json();
        const myInfo = allRequests.find(r => String(r.email || "").toLowerCase() === email.toLowerCase());
        return myInfo || { email: email };
    } catch (e) {
        console.error("é€£ç·šéŒ¯èª¤:", e);
        return null;
    }
  }

  // æ¸²æŸ“æ‰¹æ¬¡ç”³è«‹é¢æ¿
  function renderBatchPanel(userRow) {
    const panel = document.getElementById('batchPanel');
    const group = document.getElementById('checkGroup');
    group.innerHTML = '';

    // æ‰¾å‡ºå°šæœªç”³è«‹éçš„é …ç›® (ç‹€æ…‹ç‚ºç©º)
    const available = DEFAULT_TILES.filter(tile => {
      const status = (userRow[tile.name] || "").trim().toLowerCase();
      return status !== 'approved' && status !== 'pending';
    });

    if (available.length === 0) {
      panel.style.display = 'none';
      return;
    }

    panel.style.display = 'block';
    available.forEach(tile => {
      group.innerHTML += `
        <label class="check-item">
          <input type="checkbox" class="apply-checkbox" value="${tile.name}">
          <span>${tile.name}</span>
        </label>
      `;
    });
  }

  // æäº¤æ‰¹æ¬¡ç”³è«‹
  window.submitBatchRequest = async function() {
    const checkboxes = document.querySelectorAll('.apply-checkbox:checked');
    const categories = Array.from(checkboxes).map(cb => cb.value);
    
    if (categories.length === 0) return alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é …ç›®ã€‚");

    const email = localStorage.getItem('user_email');
    const empId = localStorage.getItem('user_empid');
    const btn = document.getElementById('btnBatchApply');

    btn.disabled = true;
    btn.textContent = "ç™¼é€ç”³è«‹ä¸­...";

    try {
        await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'login', 
                employee_id: empId,
                email: email,
                categories: categories
            })
        });
        alert(`å·²æäº¤ ${categories.length} é …ç”³è«‹ï¼ç®¡ç†å“¡å°‡æœƒé€²è¡Œæ ¸å‡†ã€‚`);
        location.reload();
    } catch (e) {
        alert("ç”³è«‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
        btn.disabled = false;
        btn.textContent = "æäº¤æ‰¹æ¬¡ç”³è«‹";
    }
  }

  function renderTiles(userRow) {
    const grid = document.getElementById('tileGrid');
    grid.innerHTML = '';

    DEFAULT_TILES.forEach(tile => {
      const currentStatus = (userRow[tile.name] || "").trim().toLowerCase();
      let badgeInfo = {text:'é»æ“Šç”³è«‹', cls:'locked'};
      if(currentStatus === 'approved') badgeInfo = {text:'å¯ä½¿ç”¨', cls:'open'};
      if(currentStatus === 'pending') badgeInfo = {text:'å¯©æ ¸ä¸­', cls:'pending'};

      const a = document.createElement('a');
      a.href = '#';
      a.className = 'tile';
      if (currentStatus === 'approved') a.classList.add('active');
      else {
        a.style.opacity = '0.6';
        a.style.filter = 'grayscale(1)';
      }

      a.innerHTML = `
        <span class="icon">${tile.icon}</span>
        <div class="title">${tile.name}</div>
        <span class="badge ${badgeInfo.cls}">${badgeInfo.text}</span>
      `;

      a.onclick = (e) => {
        e.preventDefault();
        if (currentStatus === 'approved') {
          window.open(tile.url, '_blank');
        } else if (currentStatus === 'pending') {
          alert('å¯©æ ¸ä¸­ï¼Œè«‹ç¨å€™ã€‚');
        } else {
          // å–®é»æ“Šä¹Ÿæœƒè©¢å•æ˜¯å¦ç”³è«‹
          if(confirm(`æ˜¯å¦ç”³è«‹ã€Œ${tile.name}ã€æ¬Šé™ï¼Ÿ`)) {
            submitBatchRequestViaSingle(tile.name);
          }
        }
      };
      grid.appendChild(a);
    });
  }

  // æ”¯æ´å–®å€‹é»æ“Šç£è²¼çš„ç”³è«‹å‹•ä½œ
  async function submitBatchRequestViaSingle(name) {
      const email = localStorage.getItem('user_email');
      const empId = localStorage.getItem('user_empid');
      try {
          await fetch(GAS_URL, {
              method: 'POST',
              body: JSON.stringify({ action: 'login', employee_id: empId, email: email, categories: [name] })
          });
          alert("ç”³è«‹å·²é€å‡ºï¼");
          location.reload();
      } catch(e) { alert("é€£ç·šå¤±æ•—"); }
  }

  function renderMe(email){
    document.getElementById('meBar').innerHTML = `ç™»å…¥è€…ï¼š<b>${email}</b> 
      &nbsp;|&nbsp; <a href="#" onclick="localStorage.clear();location.href='login.html';" style="color:var(--primary); text-decoration:none; font-weight:bold;">ç™»å‡º</a>`;
  }

  (async ()=>{
    const myInfo = await checkAuthAndGetStatus();
    if (myInfo) {
      renderMe(myInfo.email);
      renderBatchPanel(myInfo); // æ¸²æŸ“ä¸Šæ–¹æ‰¹æ¬¡é¢æ¿
      renderTiles(myInfo);
    }
  })();
})();
</script>
</body>
</html>

